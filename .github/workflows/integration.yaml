---
name: Integration/Regression

on:               # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      crs-config:
        required: true
        type: string

jobs:
  modsecurity-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    matrix:
      server: [modsec2-apache, modsec2-nginx]

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v3

      - name: "Install dependencies"
        run: |
          wget https://github.com/coreruleset/coreruleset/archive/refs/tags/nightly.tar.gz -O /tmp/nightly.tar.gz
          tar -zxvf /tmp/nightly.tar.gz -C /tmp/
          curl -skLo - https://github.com/coreruleset/go-ftw/releases/latest/download/ftw_Linux_x86_64.tar.gz | tar -xzf - ftw

      - name: "Running integration tests for ${{ matrix.server }}"
        run: |
          touch plugins/placeholder-config.conf
          touch plugins/placeholder-before.conf
          touch plugins/placeholder-after.conf

          docker cp tests/integration/modsec-setup.conf nginx-nightly:/etc/modsecurity.d/setup.conf

          echo '${{ inputs.crs_config }}' > /tmp/crs-setup.conf
          docker-compose -f tests/integration/docker-compose.yml up -d ${{ matrix.server }}-nightly

      - name: "Runing regression tests for ${{ matrix.server }}"
        run: |
          ./ftw check -d tests/regression/tests
          ./ftw run -d tests/regression/tests
        env:
          FTW_LOGFILE: './tests/logs/{{ matrix.server }}/error.log'

      - name: "Tear down tests"
        run: |
          docker-compose -f tests/integration/docker-compose.yml down
