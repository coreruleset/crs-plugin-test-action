---
name: Integration/Regression

on:
  workflow_call:
    inputs:
      crs-config:
        required: false
        type: string

jobs:
  modsecurity-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        server: [apache, nginx]
        crs_version: [nightly]

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v2

      - name: "Install dependencies"
        run: |
          mkdir -p crs
          curl -skLo - https://github.com/coreruleset/coreruleset/archive/refs/tags/${{ matrix.crs_version }}.tar.gz | tar -xvf - --strip-components=1 -C crs
          curl -skLo - https://github.com/coreruleset/go-ftw/releases/download/v0.4.0/ftw_Linux_x86_64.tar.gz | tar -xzf - ftw
          mkdir -p tests/integration
          # get latest docker-compose.yml file
          curl -skL https://raw.githubusercontent.com/coreruleset/crs-plugin-test-action/main/tests/integration/docker-compose.yml \
            -o tests/integration/docker-compose.yml
      
      - name: "Start ${{ matrix.server }} "
        run: |
          # create logs directory
          mkdir -p tests/logs/${{ matrix.server }}
          # use crs-config, if any
          echo '${{ inputs.crs-config }}' > /tmp/crs-setup.conf
          # start container
          docker-compose -f tests/integration/docker-compose.yml up -d ${{ matrix.server }}

      - name: "Run plugin tests"
        run: |
          ./ftw check -d tests/regression/tests
          ./ftw run -d tests/regression/tests
        env:
          FTW_LOGFILE: './tests/logs/{{ matrix.server }}/error.log'
      
      - name: "Tear down tests"
        run: |
          docker-compose -f tests/integration/docker-compose.yml down
